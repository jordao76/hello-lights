<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: traffic-light/morse.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: traffic-light/morse.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint no-multi-spaces: 0 */

const {isLight} = require('./validation');
const {isString} = require('../parsing/validation');
const {pause} = require('../parsing/base-commands');
const {intersperse, flatten} = require('./utils');

//////////////////////////////////////////////////////////////////////////////

// ref: https://www.itu.int/dms_pubrec/itu-r/rec/m/R-REC-M.1677-1-200910-I!!PDF-E.pdf [PDF]

const TIME_UNIT = 110; // in ms
const
  DOT_SIGNAL = 1,
  DASH_SIGNAL = 3,
  INTER_LETTER_GAP = 1,
  LETTER_GAP = 3,
  WORD_GAP = 7,
  END_OF_INPUT_GAP = 7;

const morseCode = {
  ' ': ' ',
  // Letters
  'a': '.-',    'i': '..',   'r': '.-.',
  'b': '-...',  'j': '.---', 's': '...',
  'c': '-.-.',  'k': '-.-',  't': '-',
  'd': '-..',   'l': '.-..', 'u': '..-',
  'e': '.',     'm': '--',   'v': '...-',
  'é': '..-..', 'n': '-.',   'w': '.--',
  'f': '..-.',  'o': '---',  'x': '-..-',
  'g': '--.',   'p': '.--.', 'y': '-.--',
  'h': '....',  'q': '--.-', 'z': '--..',
  // Figures
  '1': '.----', '6': '-....',
  '2': '..---', '7': '--...',
  '3': '...--', '8': '---..',
  '4': '....-', '9': '----.',
  '5': '.....', '0': '-----',
  // Punctuation marks
  '.': '.-.-.-',
  ',': '--..--',
  ':': '---...',
  '?': '..--..',
  '’': '.----.', "'": '.----.',
  '–': '-....-', '-': '-....-', '−': '-....-',
  '/': '-..-.',
  '(': '-.--.',
  ')': '-.--.-',
  '“': '.-..-.', '”': '.-..-.', '"': '.-..-.',
  '=': '-...-',
  '+': '.-.-.',
  '×': '-..-',
  '@': '.--.-.'
  // Miscellaneous signs
  /*
    Understood ...-.
    Error ........
    Invitation to transmit -.-
    Wait .-...
    End of work ...-.-
    Starting signal (to precede every transmission) -.-.-
  */
};

//////////////////////////////////////////////////////////////////////////////

/**
 * A morse singleton code signal, either a dot or a dash.
 * @typedef {("."|"-")} Signal
 * @memberof trafficLight
 */
/**
 * A morse coded letter, made up of concatenated signals.
 * E.g. '.-' for 'A'
 * @typedef {string&lt;trafficLight.Signal>} Letter
 * @memberof trafficLight
 */
/**
 * A morse coded word, made up of coded letters.
 * E.g. '.-' for 'A'
 * @typedef {trafficLight.Letter[]} Word
 * @memberof trafficLight
 */
/**
 * A morse coded phrase, made up of coded words.
 * @typedef {trafficLight.Word[]} Phrase
 * @memberof trafficLight
 */
/**
 * A relative duration in multiples of the defined time unit.
 * @typedef {number} TimeCode
 * @memberof trafficLight
 */

/**
 * @memberof trafficLight
 * @param {trafficLight.Signal} signal
 * @returns {trafficLight.TimeCode[]} Time codes.
 */
function timecodeSignal(signal) {
  if (signal === '.') return DOT_SIGNAL;
  if (signal === '-') return DASH_SIGNAL;
}

/**
 * @memberof trafficLight
 * @param {trafficLight.Letter} letter
 * @returns {trafficLight.TimeCode[]} Time codes.
 */
function timecodeLetter(letter) {             // '.-'
  let signals = letter.split('');             // ['.', '-']
  let code = signals.map(timecodeSignal);     // [1, 3]
  return intersperse(INTER_LETTER_GAP, code); // [1, 1, 3]
}

/**
 * @memberof trafficLight
 * @param {trafficLight.Word} word
 * @returns {trafficLight.TimeCode[]} Time codes.
 */
function timecodeWord(word) {               // ['.-', '.-']
  let codes = word.map(timecodeLetter);     // [[1, 1, 3], [1, 1, 3]]
  codes = intersperse([LETTER_GAP], codes); // [[1, 1, 3], [3], [1, 1, 3]]
  return flatten(codes);                    // [1, 1, 3, 3, 1, 1, 3]
}

/**
 * @memberof trafficLight
 * @param {trafficLight.Phrase} phrase
 * @returns {trafficLight.TimeCode[]} Time codes.
 */
function timecodePhrase(phrase) {         // [['.-'], ['.-']]
  let codes = phrase.map(timecodeWord);   // [[1, 1, 3], [1, 1, 3]]
  codes = intersperse([WORD_GAP], codes); // [[1, 1, 3], [7], [1, 1, 3]]
  return flatten(codes);                  // [1, 1, 3, 7, 1, 1, 3]
}

/**
 * @memberof trafficLight
 * @param {trafficLight.String} word
 * @returns {trafficLight.Word} Encoded word.
 */
function encodeWord(word) {
  return word                // 'aãa'
    .split('')               // ['a','ã','a']
    .map(c => morseCode[c])  // ['.-',undefined,'.-']
    .filter(c => !!c);       // ['.-','.-']
}

/**
 * @memberof trafficLight
 * @param {trafficLight.String} text
 * @returns {trafficLight.TimeCode[]} Time codes.
 */
function timecodeText(text) {
  let phrase = text              // ' A A'
    .toLowerCase()               // ' a a'
    .split(/\s+/)                // ['', 'a', 'a']
    .filter(w => !!w)            // ['a', 'a']
    .map(encodeWord);            // [['.-'], ['.-']]
  return timecodePhrase(phrase)  // [1, 1, 3, 7, 1, 1, 3]
    .concat([END_OF_INPUT_GAP]); // [1, 1, 3, 7, 1, 1, 3, 7]
}

//////////////////////////////////////////////////////////////////////////////

async function morse({tl, ct}, [light, text]) {
  if (ct.isCancelled) return;
  let times = timecodeText(text);
  tl[light].turnOff(); // start as 'off'
  for (let i = 0; i &lt; times.length; ++i) {
    if (ct.isCancelled) break;
    tl[light].toggle();
    await pause({ct}, [times[i] * TIME_UNIT]);
  }
}

morse.paramNames = ['light', 'text'];
morse.validation = [isLight, isString];
morse.doc = {
  name: 'morse',
  desc: 'Morse code pattern with the given light and text:\n' +
        '(morse green "hello-lights")'
};

//////////////////////////////////////////////////////////////////////////////

function defineCommands(cp) {
  cp.add('morse', morse);
}

//////////////////////////////////////////////////////////////////////////////

module.exports = {
  // morse-utils
  timecodeSignal,
  timecodeLetter,
  timecodeWord,
  timecodePhrase,
  encodeWord,
  timecodeText,
  // morse core
  morse,
  defineCommands
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Commander.html">Commander</a></li><li><a href="parsing.Cancellable.html">Cancellable</a></li><li><a href="parsing.CommandParser.html">CommandParser</a></li><li><a href="physical.Device.html">Device</a></li><li><a href="physical.DeviceManager.html">DeviceManager</a></li><li><a href="physical.PhysicalLight.html">PhysicalLight</a></li><li><a href="physical.PhysicalTrafficLight.html">PhysicalTrafficLight</a></li><li><a href="selectors.PhysicalMultiTrafficLightSelector.html">PhysicalMultiTrafficLightSelector</a></li><li><a href="selectors.PhysicalTrafficLightSelector.html">PhysicalTrafficLightSelector</a></li><li><a href="trafficLight.FlexMultiTrafficLight.html">FlexMultiTrafficLight</a></li><li><a href="trafficLight.Light.html">Light</a></li><li><a href="trafficLight.MultiLight.html">MultiLight</a></li><li><a href="trafficLight.MultiTrafficLight.html">MultiTrafficLight</a></li><li><a href="trafficLight.TrafficLight.html">TrafficLight</a></li></ul><h3>Events</h3><ul><li><a href="physical.Device.html#event:connected">connected</a></li><li><a href="physical.Device.html#event:disconnected">disconnected</a></li><li><a href="physical.DeviceManager.html#event:added">added</a></li><li><a href="physical.DeviceManager.html#event:removed">removed</a></li><li><a href="physical.PhysicalTrafficLight.html#event:disabled">disabled</a></li><li><a href="physical.PhysicalTrafficLight.html#event:enabled">enabled</a></li><li><a href="selectors.PhysicalMultiTrafficLightSelector.html#event:disabled">disabled</a></li><li><a href="selectors.PhysicalMultiTrafficLightSelector.html#event:enabled">enabled</a></li><li><a href="selectors.PhysicalMultiTrafficLightSelector.html#event:interrupted">interrupted</a></li><li><a href="selectors.PhysicalTrafficLightSelector.html#event:disabled">disabled</a></li><li><a href="selectors.PhysicalTrafficLightSelector.html#event:enabled">enabled</a></li><li><a href="trafficLight.FlexMultiTrafficLight.html#event:disabled">disabled</a></li><li><a href="trafficLight.FlexMultiTrafficLight.html#event:enabled">enabled</a></li><li><a href="trafficLight.FlexMultiTrafficLight.html#event:interrupted">interrupted</a></li><li><a href="trafficLight.MultiTrafficLight.html#event:disabled">disabled</a></li><li><a href="trafficLight.MultiTrafficLight.html#event:enabled">enabled</a></li><li><a href="trafficLight.TrafficLight.html#event:disabled">disabled</a></li><li><a href="trafficLight.TrafficLight.html#event:enabled">enabled</a></li></ul><h3>Namespaces</h3><ul><li><a href="parsing.html">parsing</a></li><li><a href="physical.html">physical</a></li><li><a href="selectors.html">selectors</a></li><li><a href="trafficLight.html">trafficLight</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Oct 24 2018 17:18:25 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
