<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: commands/interpreter.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: commands/interpreter.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/////////////////////////////////////////////////////////////////////////////

const {Parser} = require('./parser');
const {Analyzer} = require('./analyzer');
const {Generator} = require('./generator');
const {Cancellable} = require('./cancellable');

/////////////////////////////////////////////////////////////////////////////

const define = require('./define');
const baseCommands = require('./base-commands');

/////////////////////////////////////////////////////////////////////////////

/**
 * Command interpreter to execute command strings.
 * @memberof commands
 */
class Interpreter {

  /**
   * @param {object.&lt;string, commands.Command>} [commands] -
   *   Commands this interpreter recognizes.
   *   (Intrinsic commands are already available)
   */
  constructor(commands) {
    this.commands = {
      ...define.commands, // add the 'define' commands
      ...baseCommands.commands, // add the base commands
      ...commands
    };
    this.parser = new Parser();
    this.analyzer = new Analyzer(this.commands);
    this.generator = new Generator();
    this.ct = new Cancellable();
  }

  /**
   * Command names this interpreter recognizes.
   * @type {string[]}
   */
  get commandNames() {
    return Object.keys(this.commands);
  }

  /**
   * Adds a new command or redefines an existing one.
   * @param {string} name - The command name. Should be the same as the command.meta.name property.
   * @param {commands.Command} command - The command function.
   */
  add(name, command) {
    this.commands[name] = command;
  }

  /**
   * Cancels any executing commands.
   * @param {commands.Cancellable} [ct] - Cancellation token.
   */
  cancel(ct = this.ct) {
    if (ct.isCancelled) return;
    ct.cancel();
    if (ct === this.ct) {
      this.ct = new Cancellable();
    }
  }

  /**
   * Executes a command asynchronously.
   * @param {string} text - Command text to execute.
   * @param {object} [ctx] - Context object to be passed as part of the executed
   *   commands' context, together with the cancellation token.
   *   This context cannot have key 'ct', since it would be overwritten anyway.
   * @param {commands.Cancellable} [ct] - Cancellation token.
   * @throws Throws an error for any syntax or semantic errors in the text.
   * @returns {object[]} Array with the results of the executions of the commands.
   */
  async execute(text, ctx = {}, ct = this.ct) {
    let commands = this.process(text);

    let res = [];
    for (let i = 0; i &lt; commands.length; ++i) {
      if (ct.isCancelled) break;
      let command = commands[i];
      res.push(await command({...ctx, ct}));
    }

    if (ct === this.ct &amp;&amp; ct.isCancelled) {
      // this.ct was cancelled, so re-instantiate it
      this.ct = new Cancellable();
    }

    return res;
  }

  process(text) {
    // parse
    let nodes = this.parser.parse(text);
    this.raiseIfErrors(this.parser.errors);

    // analyze
    nodes = this.analyzer.analyze(nodes);
    this.raiseIfErrors(this.analyzer.errors);

    // generate
    let commands = this.generator.generate(nodes);
    this.raiseIfErrors(this.generator.errors);

    return commands || [];
  }

  raiseIfErrors(errors) {
    if (errors.length === 0) return;
    throw new Error(errors.map(this.formatError).join('\n'));
  }

  formatError(error) {
    return `${error.loc}: ${error.text}`;
  }

}

/////////////////////////////////////////////////////////////////////////////

module.exports = {Interpreter};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Commander.html">Commander</a></li><li><a href="commands.Cancellable.html">Cancellable</a></li><li><a href="commands.Interpreter.html">Interpreter</a></li><li><a href="physical.Device.html">Device</a></li><li><a href="physical.DeviceManager.html">DeviceManager</a></li><li><a href="physical.PhysicalLight.html">PhysicalLight</a></li><li><a href="physical.PhysicalTrafficLight.html">PhysicalTrafficLight</a></li><li><a href="selectors.PhysicalMultiTrafficLightSelector.html">PhysicalMultiTrafficLightSelector</a></li><li><a href="selectors.PhysicalTrafficLightSelector.html">PhysicalTrafficLightSelector</a></li><li><a href="trafficLight.FlexMultiTrafficLight.html">FlexMultiTrafficLight</a></li><li><a href="trafficLight.Light.html">Light</a></li><li><a href="trafficLight.MultiLight.html">MultiLight</a></li><li><a href="trafficLight.MultiTrafficLight.html">MultiTrafficLight</a></li><li><a href="trafficLight.TrafficLight.html">TrafficLight</a></li></ul><h3>Events</h3><ul><li><a href="physical.Device.html#event:connected">connected</a></li><li><a href="physical.Device.html#event:disconnected">disconnected</a></li><li><a href="physical.DeviceManager.html#event:added">added</a></li><li><a href="physical.DeviceManager.html#event:removed">removed</a></li><li><a href="physical.PhysicalTrafficLight.html#event:disabled">disabled</a></li><li><a href="physical.PhysicalTrafficLight.html#event:enabled">enabled</a></li><li><a href="selectors.PhysicalMultiTrafficLightSelector.html#event:disabled">disabled</a></li><li><a href="selectors.PhysicalMultiTrafficLightSelector.html#event:enabled">enabled</a></li><li><a href="selectors.PhysicalMultiTrafficLightSelector.html#event:interrupted">interrupted</a></li><li><a href="selectors.PhysicalTrafficLightSelector.html#event:disabled">disabled</a></li><li><a href="selectors.PhysicalTrafficLightSelector.html#event:enabled">enabled</a></li><li><a href="trafficLight.FlexMultiTrafficLight.html#event:disabled">disabled</a></li><li><a href="trafficLight.FlexMultiTrafficLight.html#event:enabled">enabled</a></li><li><a href="trafficLight.FlexMultiTrafficLight.html#event:interrupted">interrupted</a></li><li><a href="trafficLight.MultiTrafficLight.html#event:disabled">disabled</a></li><li><a href="trafficLight.MultiTrafficLight.html#event:enabled">enabled</a></li><li><a href="trafficLight.TrafficLight.html#event:disabled">disabled</a></li><li><a href="trafficLight.TrafficLight.html#event:enabled">enabled</a></li></ul><h3>Namespaces</h3><ul><li><a href="commands.html">commands</a></li><li><a href="physical.html">physical</a></li><li><a href="selectors.html">selectors</a></li><li><a href="trafficLight.html">trafficLight</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Apr 21 2019 14:09:40 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
